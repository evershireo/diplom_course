# Поиск и устранение неисправностей

Для эффективного поиска и устранения неисправностей, возможные неисправности принято делить на пять групп

Классификация неисправностей в Linux-системах — это важный аспект системного администрирования, который позволяет эффективно управлять ресурсами, поддерживать высокую доступность и минимизировать простои. Разделение проблем на категории помогает быстро идентифицировать корневую причину и выбрать правильные инструменты для диагностики и решения. Рассмотрим основные типы неисправностей и инструменты, которые можно использовать для их диагностики.

Некоторых инструментов нет в системе по умолчанию, их необходимо доустановить в зависимости от дистрибутива.

## 1. Сетевые неисправности

Основные проблемы:

- Потеря соединения
- Высокая задержка
- Низкая пропускная способность

Инструменты для диагностики:

- ping: проверяет доступность удаленного узла и измеряет задержку.
- traceroute: анализирует маршрут данных между источником и назначением.
- netstat/ss: показывает открытые сетевые соединения и порты.
- tcpdump: захватывает пакеты для анализа сетевого трафика.
- iftop: показывает текущее использование пропускной способности.
- iperf: тестирование производительности сети.

Рассмотрим пример поиска и устранения сетевой неисправности:

На сервере пропал доступ в интернет

1. Пробуем проверить доступ в сеть по доменному имени, для этого используем утилиту `ping`

```bash
$ ping ya.ru
```

2. Выяснили, что по доменному имени `ping` не работает, пробуем произвести `ping` по адресу

```bash
$ ping 77.88.8.8
```

3. Если ping работает по адресу, но не работает по имени -- неисправен DNS сервер, пробуем изменить DNS на другой или идем смотреть сервис. 

4. Чтобы определить точку отказа используем `traceroute`

```bash
$ traceroute 77.88.8.8
```

5. В выводе утилиты `traceroute` смотрим, где пропадает узел, локализуем проблему

Если проблема заключается в недоступности какого-либо сервиса на сервере -- следует проверить, а слушает ли сервис порт, при помощи команды

```bash
$ ss -tunlp | grep 80
```

Таким образом можно локализовать проблему с сервисом. Когда проблема локализована -- стоит применить `tcpdump` для анализа входящего трафика

В случаях медленной работы сети стоит применить утилиту `iperf` для тестирования производительности сети, а также `iftop` для проверки загруженности сетевых адаптеров

## 2. Дисковая подсистема

Основные проблемы:

- Недостаток свободного места
- Высокая нагрузка на диск
- Повреждение данных

Инструменты для диагностики:

- df: показывает использование дискового пространства.
- du: анализирует использование пространства на уровне каталогов.
- iostat: предоставляет статистику ввода-вывода на уровне системы.
- smartctl: проверяет состояние накопителей с поддержкой SMART.
- fsck: проверяет и исправляет ошибки файловой системы.

При неисправностях дисковой подсистемы может значительно ушудшится производительность, особенно на операциях, предполагающих работу с файлами и данными в файловой системе

Первое, что стоит проверить -- свободное место на жестком диске, при помощи утилиты `df`. Если свободного места слишком мало -- стоит его освободить, удалив не нужные файлы. Как определить, какие именно файлы нужно удалять? Поможет утилита `du`. Данная утилита показывает, сколько места занимает каждый из файлов

Если со свободным местом все в порядке -- стоит проверить производительность подсистемы ввода-вывода, сделать это можно при помощи `iostat`. При обнаружении высокого значения `await` необходимо распределить нагрузку на диски, например, используя raid, или завершить процесс, который генерирует нагрузку.

Кроме того, проблеммы могут возникать из-за большого износа дисковой подсистемы. Для проверки износа дисков стоит использовать `smartctl`. При обнаружении проблем стоит произвести проверку диска при помощи `fsck`, в идеале -- заменить изношенные носители информации.

## 3. Проблемы с производительностью

Основные проблемы:

- Высокая загрузка CPU
- Нехватка оперативной памяти
- Задержки во ввода-выводе

Инструменты для диагностики:

- top/htop: показывает информацию о загрузке процессора и памяти.
- vmstat: предоставляет отчеты о виртуальной памяти и производительности процессора.
- free: показывает использование оперативной памяти.
- dstat: комбинирует информацию о процессоре, памяти, дисках и сети.
- perf: инструмент для профилирования системы.

В случае, если сервер работает медленно, при этом с сетью и дисковой подсистемой все в порядке, стоит проверить нагрузку на вычислительные ресурсы. Для диагностики вычислительных ресурсов подходят утилиты `top` и `htop`. При помощи данных утилит можно вычислить, какое приложение генерирует нагрузку на систему, тем самым локализовав проблему. Если данных в `top` и `htop` недостаточно -- можно использовать `vmstat`. `vmstat` поможет определить нагрузку на раздел подкачки. Стоит также проверить количество доступной оперативной памяти, при помощи утилиты `free`.

Если инструменты по отдельности не дают возможности локализовать проблему -- нужно использовать `dstat` и `perf`. Первая утилита позволяет производить комплексный мониторинг всех компонентов системы, а вторая утилита -- профилировщик, который показывает, на какие именно системные вызовы тратиться процессорное время.

## 4. Проблемы с безопасностью

Основные проблемы:

- Неавторизованный доступ
- Уязвимости программного обеспечения
- Неправильные настройки прав доступа

Инструменты для диагностики:

- auditd: следит за событиями безопасности в системе.
- chkrootkit/rkhunter: сканируют на наличие руткитов.
- nmap: сканирует сеть на предмет открытых портов и служб.
- fail2ban: автоматически блокирует IP-адреса за подозрительную активность.
- nftables: настройка брандмауэра для фильтрации трафика.

Если в системе происходят странные вещи, например, часто изменяются системные файлы, может помочь включение аудита системы, при помощи `auditctl`. Аудит позволяет отслеживать, кто и когда вносил изменения в файлы. Таким образом можно вычислить, например, вредоносный процесс.

## 5. Проблемы с программным обеспечением

Основные проблемы:

- Сбои приложений
- Конфликты зависимостей
- Ошибки конфигурации

Инструменты для диагностики:

- Логи системных и прикладных журналов, например, с помощью journalctl для систем с systemd.
- strace: отладка выполнения системных вызовов приложением.
- lsof: показывает открытые файлы и сети, используемые процессами.
- gdb: инструмент отладки для анализа аварийных завершений приложений.

При проблеммах с сервисами и програмным обеспечением, первое, на что следует обратить внимание -- логи. Даже если приложение не пишет логи, можно проверить сопутствующие сервисы при помощи утилиты `journalctl`. Если информации из `journalctl` недостаточно, стоит просмотреть системные вызовы процесса при помощи `strace`. `strace` позволит выяснить, что именно пытается сделать процесс и на каком системном вызове происходит ошибка. Если приложение использует слишком много системных ресурсов, либо вызывает утечку памяти -- стоит проверить утилиту `lsof`. Данная утилита покажет, с какими файлами или сетевыми сокетами работает приложение.  Если же проблему не удается локализовать при помощи вышеперечисленных утилит -- стоит попробовать выполнить отладку при помощи `gdb`.
